<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropper/4.1.0/cropper.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropper/4.1.0/cropper.min.js"></script>

    <style>
        .not-visible {
            display: none;
        }
    </style>

    <title>Image Cropper</title>
</head>

<body>
    <div class="container mt-3">

        <div class="row">
            <div class="col-md-12 text-right">
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#uploadPictureForm">
                    Upload Picture
                </button>
            </div>
        </div>

        <div class="modal" id="uploadPictureForm">
            <div class="modal-dialog">
                <div class="modal-content">

                    <div class="modal-header">
                        <h4 class="modal-title">Upload Picture</h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>

                    <form action="" id="image-form" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="modal-body">
                            <ul class="nav nav-tabs" id="shapeTabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="image-tab" data-toggle="tab" href="#image" role="tab"
                                        aria-controls="image" aria-selected="true">Image</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="square-tab" data-toggle="tab" href="#square" role="tab"
                                        aria-controls="square" aria-selected="false">Square</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="rectangle-tab" data-toggle="tab" href="#rectangle"
                                        role="tab" aria-controls="rectangle" aria-selected="false">Rectangle</a>
                                </li>
                            </ul>
                            <br />
                            <div id="alert-box"></div>
                            <div id="image-box" class="mb-3"></div>
                            <input type="file" name="file" id="id_file" accept="image/*">
                            <input type="file" name="square" id="id_square" class="not-visible">
                            <input type="file" name="rectangle" id="id_rectangle" class="not-visible">
                    </form>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-primary not-visible" id="confirm-btn">Confirm</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    </div>

    <div id="cropped-image-container" class="not-visible mt-3" hidden>
        <img id="cropped-image" src="" alt="Cropped Image">
    </div>

    <div class="container mt-3">
        <h2>Uploaded Images</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Original Image</th>
                    <th>Square Image</th>
                    <th>Rectangle Image</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="image-table-body">
                {% for image in images %}
                <tr>
                    <td>{{ image.id }}</td>
                    <td><img src="{{ image.image.url }}" alt="Original Image" style="width: 100px;"></td>
                    {% if image.square %}
                        <td><img src="{{ image.square.url }}" alt="Square Image" style="width: 100px;"></td>
                    {% else %}
                        <td>No square image available</td>
                    {% endif %}
                    {% if image.rectangle %}
                        <td><img src="{{ image.rectangle.url }}" alt="Rectangle Image" style="width: 100px;"></td>
                    {% else %}
                        <td>No rectangle image available</td>
                    {% endif %}
                    <td>
                        <button type="button" class="btn btn-primary edit-btn" data-image-id="{{ image.id }}">Edit</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            
        </table>
    </div>


    <script>
        $(document).ready(function () {

            $('#id_file').on('change', function () {
                $("#uploadPictureForm").modal('show')

            });


            $('#id_file').on('change', function () {
                console.log('=-=-=-=-=File changed=-=-=-=-=');
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        $('#image').html(`<img src="${e.target.result}" alt="Image" style="max-width: 100%;">`);
                    };
                    reader.readAsDataURL(file);
                    console.log('=-=-=-=-=-=-=-=-=', file);
                }
            });



            $('#shapeTabs a').on('click', function (e) {
                e.preventDefault();
                $(this).tab('show');
                const tabId = $(this).attr('href');
                $('#image-form input[type="file"]').addClass('not-visible');
                console.log('=-=-=-=-=-=-=-=-=-', tabId)
                $(`${tabId}-tab input[type="file"]`).removeClass('not-visible');
                console.log('=-=-=-=-=-=-=-=-=-', tabId)

                if (tabId === '#image') {
                    $('#id_file').removeClass('not-visible');
                }

            });

            // $('.edit-btn').on('click', function () {
            //     const imageId = $(this).data('image-id');
            //     $('#uploadPictureForm').modal('show');

            //     const formData = new FormData($('#edit-image-form')[0]);

            //     $.ajax({
            //         url: `/crop-image/${imageId}/`,
            //         type: 'PUT',
            //         data: formData,
            //         processData: false, 
            //         contentType: false, 
            //         success: function (response) {
            //             console.log('Image updated successfully:', response);
            //         },
            //         error: function (error) {
            //             console.error('Error updating image:', error.responseJSON.message);
            //         }
            //     });
            // });


            const alertBox = document.getElementById('alert-box')
            const imageBox = document.getElementById('image-box')
            const imageForm = document.getElementById('image-form')
            const confirmBtn = document.getElementById('confirm-btn')
            const input = document.getElementById('id_file')
            const shapeTabs = document.querySelectorAll('.nav-link');
            let aspectRatio = 1;
            let stepCount = 0;
            const csrf = document.getElementsByName('csrfmiddlewaretoken')

            input.addEventListener('change', () => {
                console.log('-=---=-==--==-=--===', input);
                alertBox.innerHTML = ""
                confirmBtn.classList.remove('not-visible')
                const img_data = input.files[0]
                const url = URL.createObjectURL(img_data)
                console.log('=-=-=-=-=-=-=-=-=-=-=-', url);

                imageBox.innerHTML = `<img src="${url}" id="image" width="466px">`
                var $image = $('#image')
                console.log('=-=-=-=-=-=-=-=-=-=-=-=-=');
                console.log('=-=-=-=-=-=-=-=-=-', imageBox);

                $image.cropper({
                    aspectRatio: aspectRatio,
                    crop: function (event) {
                        console.log("---x----", event.detail.x);
                        console.log("---y----", event.detail.y);
                        console.log("---width----", event.detail.width);
                        console.log("---height----", event.detail.height);
                        console.log("---rotate----", event.detail.rotate);
                        console.log("---scaleX----", event.detail.scaleX);
                        console.log("---scaleY----", event.detail.scaleY);
                        console.log('=-=-=-=-=-=-=-=-=-=', aspectRatio);
                        console.log('=-=-=-=-=-=-=-=-=-=', image);
                    }
                });

                shapeTabs.forEach(tab => {
                    tab.addEventListener('click', function () {
                        if (this.getAttribute('id') == 'id_file') {
                            aspectRatio = 0;
                        }

                        if (this.getAttribute('id') == 'square-tab') {
                            aspectRatio = 1;
                            console.log('=-=-=-=-=-=-=-=-=-==--==', shapeTabs);
                        } else if (this.getAttribute('id') == 'rectangle-tab') {
                            aspectRatio = 16 / 9;
                        }
                        $image.cropper('destroy').cropper({ aspectRatio: aspectRatio });
                    });
                });

                confirmBtn.addEventListener('click', () => {

                    const cropper = $image.data('cropper');
                    const canvas = cropper.getCroppedCanvas();
                    if (!canvas) {
                        alertBox.innerHTML = `<div class="alert alert-danger" role="alert">
                                Please make sure to crop the image before confirming.
                             </div>`;
                        return;
                    }

                    canvas.toBlob((blob) => {
                        const Image_upload = new FormData();
                        Image_upload.append('csrfmiddlewaretoken', csrf[0].value)
                        Image_upload.append('image', blob, 'original.jpeg');
                        console.log('=-=-=-=-=-=-=-=-=-=',Image_upload);
                        Image_upload.append('square', blob, 'Square.jpeg');
                        console.log('=-=-=-=-=-=-=-=-=-=',Image_upload);
                        Image_upload.append('rectangle', blob, 'Rectangle.jpeg');
                        console.log('=-=-=-=-=-=-=-=-=-=',Image_upload);


                        $.ajax({
                            type: 'POST',
                            url: imageForm.action,
                            data: Image_upload,
                            success: function (response) {
                                alertBox.innerHTML = `<div class="alert alert-success" role="alert">
                                            Successfully saved and cropped the selected image
                                         </div>`;
                                const croppedImageUrl = URL.createObjectURL(blob);
                                // let new_row = `
                                //         <tr data-row-id="${image.id}">
                                //             <td>${image.id}</td>
                                //             <td><img src="${image.image.url}" alt="Original Image" style="width: 100px;"></td>
                                //             <td><img src="${image.square.url}" alt="Square Image" style="width: 100px;"></td>
                                //             <td><img src="${image.rectangle.url}" alt="Rectangle Image" style="width: 100px;"></td>
                                //             <td>
                                //                 <button type="button" class="btn btn-primary edit-btn" data-image-id="${image.id}">Edit</button>
                                //             </td>
                                //         </tr>`;

                                    // $('#image-table-body').prepend(new_row);
                                    
                                    $('#cropped-image').attr('src', croppedImageUrl);
                                    $('#cropped-image-container').removeClass('not-visible');
                                    $('#uploadPictureForm').modal('hide');
                                
                            },
                            error: function (error) {
                                alertBox.innerHTML = `<div class="alert alert-danger" role="alert">
                                            Oops... Something went wrong
                                         </div>`;
                            },
                            processData: false,
                            contentType: false,
                        });
                    });
                });
            })
        });
    </script>

</body>

</html>